<script>
(function(){
  /* ── Pause/resume infinite animations when widgets leave viewport ── */
  if(typeof IntersectionObserver==='undefined')return;
  var widgetIO = new IntersectionObserver(function(entries){
    entries.forEach(function(e){
      e.target.classList.toggle('in-view', e.isIntersecting);
    });
  }, {rootMargin:'100px'});
  document.querySelectorAll('.interactive-widget').forEach(function(el){
    widgetIO.observe(el);
  });
})();
</script>

<script>
(function(){
  /* ── Lightweight C++ syntax highlighter for code-diff blocks ── */
  var els = document.querySelectorAll('.code-diff .cd-code');
  if (!els.length) return;

  var KW_SET = 'if|else|for|while|do|switch|case|default|break|continue|return|class|struct|enum|namespace|using|template|typename|typedef|public|private|protected|virtual|override|const|constexpr|static|inline|explicit|noexcept|nullptr|true|false|new|delete|this|throw|try|catch|operator|sizeof|alignof|static_cast|dynamic_cast|reinterpret_cast|const_cast|assert';
  var KW = new RegExp('\\b(' + KW_SET + ')\\b', 'g');
  var KW_CHECK = new Set(KW_SET.split('|'));

  var TY = /\b(void|int|uint32_t|uint64_t|int32_t|int64_t|size_t|bool|float|double|char|auto|string|std|vector|queue|unordered_set|unordered_map|function|pair|ResourceHandle|ResourceIndex|ResourceDesc|ResourceEntry|ResourceVersion|ResourceState|RenderPass|FrameGraph|Barrier|CompiledPlan|PassIndex|BlockIndex|PhysicalBlock|Lifetime|Format|RGBA8|RGBA16F|R8|D32F|Undefined|ColorAttachment|DepthAttachment|ShaderRead|UnorderedAccess|Present|UINT32_MAX)\b/g;
  var NUM = /\b(0[xX][0-9a-fA-F]+|\d+\.\d*[fF]?|\d*\.\d+[fF]?|\d+[uUlLfF]?)\b/g;
  var STR = /("[^"\\]*(?:\\.[^"\\]*)*"|'[^'\\]*(?:\\.[^'\\]*)*')/g;
  var CMT = /(\/\/.*$|\/\*[\s\S]*?\*\/)/gm;
  var PREP = /^(\s*#\s*(?:include|define|ifdef|ifndef|endif|pragma|if|elif|else|undef|error)\b.*)/gm;
  var INC = /(<[^>]+>)/g;
  var FN = /\b([a-zA-Z_]\w*)\s*(?=\()/g;
  var MEMBER = /(?:[.])([a-zA-Z_]\w*)/g;
  var ARROW_MEMBER = /(?:->)([a-zA-Z_]\w*)/g;

  function hl(code) {
    var t = code, slots = [], id = 0;

    /* Each placeholder is a single Unicode Private-Use-Area char (U+E000+).
       No \b, \w, \d, [a-zA-Z_] regex can ever match these, so later
       passes cannot corrupt earlier results. */
    function put(cls, text) {
      var k = String.fromCharCode(0xE000 + id++);
      slots.push({k:k, v:'<span class="'+cls+'">'+text+'</span>'});
      return k;
    }

    /* 1. Comments — protect first */
    t = t.replace(CMT, function(m){ return put('cd-cmt', m); });
    /* 2. Strings */
    t = t.replace(STR, function(m){ return put('cd-str', m); });
    /* 3. Preprocessor (highlight <path> inside before protecting) */
    t = t.replace(PREP, function(m){
      var inner = m.replace(INC, function(inc){ return put('cd-str', inc); });
      return put('cd-prep', inner);
    });
    /* 4. Function calls */
    t = t.replace(FN, function(_, name){
      if (KW_CHECK.has(name)) return name;
      return put('cd-fn', name);
    });
    /* 5. Keywords */
    t = t.replace(KW, function(_, w){ return put('cd-kw', w); });
    /* 6. Types */
    t = t.replace(TY, function(_, w){ return put('cd-type', w); });
    /* 7. Numbers */
    t = t.replace(NUM, function(_, w){ return put('cd-num', w); });
    /* 8. Member access: .name */
    t = t.replace(MEMBER, function(full, name){
      return '.' + put('cd-member', name);
    });
    /* 9. Arrow member: ->name */
    t = t.replace(ARROW_MEMBER, function(full, name){
      return '->' + put('cd-member', name);
    });

    /* Restore placeholders — inner-most (last created) first */
    for (var i = slots.length - 1; i >= 0; i--) {
      t = t.split(slots[i].k).join(slots[i].v);
    }
    return t;
  }

  els.forEach(function(el){
    el.innerHTML = hl(el.textContent);
  });
})();
</script>

<script>
/* ═══ Site-wide Navigation ═══════════════════════════════════════════
   Progress bar + breadcrumbs + TOC rail for every page.
   Skips automatically when article-nav shortcode is present.
   ═══════════════════════════════════════════════════════════════════ */
(function(){
  /* If article-nav is already active, it handles everything */
  if (document.getElementById('anav-top')) return;

  function init() {
    /* ── Breadcrumbs from URL ─────────────────────────────────────── */
    var baseMeta = document.querySelector('meta[name="snav-base"]');
    var basePath = baseMeta ? baseMeta.content.replace(/\/$/,'') : '';
    var rawPath  = location.pathname;
    if (basePath && rawPath.indexOf(basePath) === 0) rawPath = rawPath.substring(basePath.length);
    var path = rawPath.replace(/^\/|\/$/g, '');
    var segments = path ? path.split('/') : [];

    var h1El = document.querySelector('article h1') ||
               document.querySelector('main h1') ||
               document.querySelector('h1');
    var pageTitle = h1El
      ? h1El.textContent.trim()
      : document.title.split('|')[0].split('·')[0].trim();

    var niceNames = {
      posts:'Posts', about:'About', tags:'Tags',
      categories:'Categories', series:'Series', authors:'Authors'
    };

    var crumbs = [{ name: 'Deep Spark', url: basePath + '/' }];
    for (var i = 0; i < segments.length; i++) {
      var seg = segments[i];
      var isLast = i === segments.length - 1;
      if (isLast) {
        crumbs.push({
          name: segments.length === 1
            ? (niceNames[seg] || pageTitle)
            : pageTitle,
          url: null
        });
      } else {
        crumbs.push({
          name: niceNames[seg] || seg.charAt(0).toUpperCase() + seg.slice(1),
          url: basePath + '/' + segments.slice(0, i + 1).join('/') + '/'
        });
      }
    }

    /* ── Scan headings for TOC ────────────────────────────────────── */
    var article = document.querySelector('article') ||
                  document.querySelector('.prose') ||
                  document.querySelector('main');
    var rawH = article ? article.querySelectorAll('h2, h3') : [];
    var tocItems = [];
    rawH.forEach(function(h) {
      var text = h.textContent.trim();
      if (text.length < 2) return;
      if (!h.id) h.id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/, '');
      tocItems.push({ name: text, el: h, id: h.id, level: parseInt(h.tagName.charAt(1)) });
    });
    var hasToc = tocItems.length >= 3;

    /* ── Build DOM ────────────────────────────────────────────────── */
    var html = '<div class="snav-top" id="snav-top">' +
      '<div class="snav-progress-track"><div class="snav-progress-bar" id="snav-progress-bar"></div></div>' +
      '</div>';

    /* Side rail */
    if (hasToc) {
      html += '<div class="snav-rail" id="snav-rail">' +
        '<button class="snav-rail-minimize" id="snav-rail-minimize" aria-label="Minimize navigation" title="Minimize">\u2039</button>' +
        '<div class="snav-rail-inner" id="snav-rail-inner">' +
        '<div class="snav-rail-title">On this page</div>' +
        '<div class="snav-rail-items" id="snav-rail-items">';
      tocItems.forEach(function(item) {
        var indent = item.level === 3 ? ' style="padding-left:1.8em;font-size:.9em;opacity:.8"' : '';
        var sName = item.name.length > 30 ? item.name.substring(0, 30) + '\u2026' : item.name;
        html += '<div class="snav-rail-link" data-target="' + item.id + '"' + indent + '>' + sName + '</div>';
      });
      html += '</div><div class="snav-rail-pct-bottom" id="snav-rail-pct">0% read</div></div></div>';
      html += '<div class="snav-mobile-backdrop" id="snav-mobile-backdrop"></div>';
      html += '<button class="snav-mobile-fab" id="snav-mobile-fab" aria-label="Open navigation">\u2630</button>';
    }

    var tmp = document.createElement('div');
    tmp.innerHTML = html;
    while (tmp.firstChild) document.body.appendChild(tmp.firstChild);

    /* ── References ───────────────────────────────────────────────── */
    var topEl      = document.getElementById('snav-top');
    var barEl      = document.getElementById('snav-progress-bar');
    var railEl     = document.getElementById('snav-rail');
    var railPctEl  = document.getElementById('snav-rail-pct');
    var railItemsE = document.getElementById('snav-rail-items');

    /* ── Minimize button toggle ───────────────────────────────────── */
    if (railEl) {
      var minBtn = document.getElementById('snav-rail-minimize');
      if (minBtn) {
        minBtn.addEventListener('click', function() {
          var isMin = railEl.classList.toggle('minimized');
          minBtn.setAttribute('aria-label', isMin ? 'Expand navigation' : 'Minimize navigation');
          minBtn.title = isMin ? 'Expand' : 'Minimize';
        });
      }
    }

    /* ── Rail click → smooth scroll ───────────────────────────────── */
    if (railItemsE) {
      railItemsE.querySelectorAll('[data-target]').forEach(function(el) {
        el.addEventListener('click', function() {
          var t = document.getElementById(el.getAttribute('data-target'));
          if (t) { t.scrollIntoView({ behavior:'smooth', block:'start' }); closeMobile(); }
        });
      });
    }


    /* ── Mobile FAB & backdrop ────────────────────────────────────── */
    var fab = document.getElementById('snav-mobile-fab');
    var bkd = document.getElementById('snav-mobile-backdrop');

    function openMobile()  { if(railEl) railEl.classList.add('snav-rail-open'); if(bkd) bkd.classList.add('active'); if(fab) fab.textContent='\u2715'; }
    function closeMobile() { if(railEl) railEl.classList.remove('snav-rail-open'); if(bkd) bkd.classList.remove('active'); if(fab) fab.textContent='\u2630'; }

    if (fab) fab.addEventListener('click', function() {
      railEl.classList.contains('snav-rail-open') ? closeMobile() : openMobile();
    });
    if (bkd) bkd.addEventListener('click', closeMobile);

    /* Swipe-down to close mobile rail */
    if (hasToc) {
      var railInner = document.getElementById('snav-rail-inner');
      var startY = 0;
      railInner.addEventListener('touchstart', function(e){ startY = e.touches[0].clientY; }, { passive:true });
      railInner.addEventListener('touchend', function(e){
        if (e.changedTouches[0].clientY - startY > 60 && railInner.scrollTop <= 0) closeMobile();
      }, { passive:true });
    }

    /* ── Scroll tracking ──────────────────────────────────────────── */
    var ticking = false;
    var prevActive = null;          /* cache to avoid querySelectorAll */
    var railInnerRef = hasToc ? document.getElementById('snav-rail-inner') : null;

    function onScroll() {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(function() {
        ticking = false;

        /* ── Reads first (avoid layout thrashing) ──────────────── */
        var scrollY  = window.scrollY || window.pageYOffset;
        var docH     = document.documentElement.scrollHeight - window.innerHeight;
        var pct      = docH > 0 ? Math.min(100, Math.round(scrollY / docH * 100)) : 0;
        var show     = scrollY > 150;

        var cur = null;
        if (hasToc) {
          for (var i = tocItems.length - 1; i >= 0; i--) {
            if (tocItems[i].el.getBoundingClientRect().top <= 80) { cur = tocItems[i]; break; }
          }
        }

        /* ── Writes ────────────────────────────────────────────── */
        topEl.classList.toggle('visible', show);
        document.body.classList.toggle('snav-active', show);
        if (railEl) railEl.classList.toggle('visible', show);

        barEl.style.transform = 'scaleX(' + (pct / 100) + ')';
        if (railPctEl) railPctEl.textContent = pct + '% read';

        /* Scrollspy — swap only changed active link */
        if (hasToc) {
          if (cur) {
            var next = railItemsE.querySelector('[data-target="' + cur.id + '"]');
            if (next !== prevActive) {
              if (prevActive) prevActive.classList.remove('active');
              if (next) {
                next.classList.add('active');
                /* Scroll rail to keep active visible (reads after all class writes) */
                var lr = next.getBoundingClientRect(), rr = railInnerRef.getBoundingClientRect();
                if (lr.bottom > rr.bottom || lr.top < rr.top) next.scrollIntoView({ block:'nearest' });
              }
              prevActive = next;
            }
          } else {
            if (prevActive) { prevActive.classList.remove('active'); prevActive = null; }
          }
        }
      });
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    setTimeout(onScroll, 100);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

<!-- Auto-hide sidebar TOC when it touches/overlaps content -->
<script>
(function () {
  if (typeof ResizeObserver === 'undefined') return;

  // The outer wrapper that holds the sidebar TOC
  var tocOuter = document.querySelector('.toc-right');
  if (!tocOuter) tocOuter = document.querySelector('.toc');
  var sidebarWrap = tocOuter && tocOuter.closest('div.order-first');
  var contentWrap = document.querySelector('.article-content');
  if (!sidebarWrap || !contentWrap) return;

  var raf = null;

  function check() {
    raf = null;

    // Use window width vs content right to decide overlap,
    // avoiding the toggle-measure-toggle reflow pattern.
    var contentRect = contentWrap.getBoundingClientRect();
    // Sidebar sits after content; if remaining space is too narrow, hide it.
    var spaceRight = window.innerWidth - contentRect.right;
    var overlaps = spaceRight < 280; // sidebar ~256px + 16px gap + tolerance

    if (overlaps) {
      document.body.classList.add('toc-sidebar-hidden');
    } else {
      document.body.classList.remove('toc-sidebar-hidden');
    }
  }

  function scheduleCheck() {
    if (!raf) raf = requestAnimationFrame(check);
  }

  // Watch for size changes on both the content and viewport
  var ro = new ResizeObserver(scheduleCheck);
  ro.observe(contentWrap);
  ro.observe(sidebarWrap);
  ro.observe(document.documentElement);

  // Also recheck on window resize (catches zoom, orientation, etc.)
  window.addEventListener('resize', scheduleCheck, { passive: true });

  check(); // initial run
})();
</script>


