<script>
(function(){
  /* ── Pause/resume infinite animations when widgets leave viewport ── */
  if(typeof IntersectionObserver==='undefined')return;
  var widgetIO = new IntersectionObserver(function(entries){
    entries.forEach(function(e){
      e.target.classList.toggle('in-view', e.isIntersecting);
    });
  }, {rootMargin:'100px'});
  document.querySelectorAll('.interactive-widget').forEach(function(el){
    widgetIO.observe(el);
  });
})();
</script>

<script>
(function(){
  /* ── Lightweight C++ syntax highlighter for code-diff blocks ── */
  var els = document.querySelectorAll('.code-diff .cd-code');
  if (!els.length) return;

  var KW_SET = 'if|else|for|while|do|switch|case|default|break|continue|return|class|struct|enum|namespace|using|template|typename|typedef|public|private|protected|virtual|override|const|constexpr|static|inline|explicit|noexcept|nullptr|true|false|new|delete|this|throw|try|catch|operator|sizeof|alignof|static_cast|dynamic_cast|reinterpret_cast|const_cast|assert';
  var KW = new RegExp('\\b(' + KW_SET + ')\\b', 'g');
  var KW_CHECK = new Set(KW_SET.split('|'));

  var TY = /\b(void|int|uint32_t|uint64_t|int32_t|int64_t|size_t|bool|float|double|char|auto|string|std|vector|queue|unordered_set|unordered_map|function|pair|ResourceHandle|ResourceIndex|ResourceDesc|ResourceEntry|ResourceVersion|ResourceState|RenderPass|FrameGraph|Barrier|CompiledPlan|PassIndex|BlockIndex|PhysicalBlock|Lifetime|Format|RGBA8|RGBA16F|R8|D32F|Undefined|ColorAttachment|DepthAttachment|ShaderRead|UnorderedAccess|Present|UINT32_MAX)\b/g;
  var NUM = /\b(0[xX][0-9a-fA-F]+|\d+\.\d*[fF]?|\d*\.\d+[fF]?|\d+[uUlLfF]?)\b/g;
  var STR = /("[^"\\]*(?:\\.[^"\\]*)*"|'[^'\\]*(?:\\.[^'\\]*)*')/g;
  var CMT = /(\/\/.*$|\/\*[\s\S]*?\*\/)/gm;
  var PREP = /^(\s*#\s*(?:include|define|ifdef|ifndef|endif|pragma|if|elif|else|undef|error)\b.*)/gm;
  var INC = /(<[^>]+>)/g;
  var FN = /\b([a-zA-Z_]\w*)\s*(?=\()/g;
  var MEMBER = /(?:[.])([a-zA-Z_]\w*)/g;
  var ARROW_MEMBER = /(?:->)([a-zA-Z_]\w*)/g;

  function hl(code) {
    var t = code, slots = [], id = 0;

    /* Each placeholder is a single Unicode Private-Use-Area char (U+E000+).
       No \b, \w, \d, [a-zA-Z_] regex can ever match these, so later
       passes cannot corrupt earlier results. */
    function put(cls, text) {
      var k = String.fromCharCode(0xE000 + id++);
      slots.push({k:k, v:'<span class="'+cls+'">'+text+'</span>'});
      return k;
    }

    /* 1. Comments — protect first */
    t = t.replace(CMT, function(m){ return put('cd-cmt', m); });
    /* 2. Strings */
    t = t.replace(STR, function(m){ return put('cd-str', m); });
    /* 3. Preprocessor (highlight <path> inside before protecting) */
    t = t.replace(PREP, function(m){
      var inner = m.replace(INC, function(inc){ return put('cd-str', inc); });
      return put('cd-prep', inner);
    });
    /* 4. Function calls */
    t = t.replace(FN, function(_, name){
      if (KW_CHECK.has(name)) return name;
      return put('cd-fn', name);
    });
    /* 5. Keywords */
    t = t.replace(KW, function(_, w){ return put('cd-kw', w); });
    /* 6. Types */
    t = t.replace(TY, function(_, w){ return put('cd-type', w); });
    /* 7. Numbers */
    t = t.replace(NUM, function(_, w){ return put('cd-num', w); });
    /* 8. Member access: .name */
    t = t.replace(MEMBER, function(full, name){
      return '.' + put('cd-member', name);
    });
    /* 9. Arrow member: ->name */
    t = t.replace(ARROW_MEMBER, function(full, name){
      return '->' + put('cd-member', name);
    });

    /* Restore placeholders — inner-most (last created) first */
    for (var i = slots.length - 1; i >= 0; i--) {
      t = t.split(slots[i].k).join(slots[i].v);
    }
    return t;
  }

  els.forEach(function(el){
    el.innerHTML = hl(el.textContent);
  });
})();
</script>

<script>
(function () {
  var emojiRe = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{27BF}\u{2B50}\u{2B55}\u{231A}-\u{23F3}\u{23CF}\u{2934}-\u{2935}\u{25AA}-\u{25FE}\u{2702}-\u{27B0}\u{FE00}-\u{FE0F}\u{200D}\u{20E3}\u{E0020}-\u{E007F}\u{1FA70}-\u{1FAFF}\u{1F900}-\u{1F9FF}\u{1F018}-\u{1F270}\u{238C}-\u{2454}\u{20D0}-\u{20FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu;

  function cleanTextNode(node) {
    var value = node.nodeValue;
    emojiRe.lastIndex = 0;
    if (!value || !emojiRe.test(value)) return;
    emojiRe.lastIndex = 0;
    node.nodeValue = value.replace(emojiRe, '').replace(/\s{2,}/g, ' ');
  }

  function shouldSkip(el) {
    return !!el.closest('code, pre, kbd, samp, script, style, textarea, .highlight, .chroma');
  }

  function stripRenderedEmoji(root) {
    if (!root) return;
    var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
      acceptNode: function (node) {
        var parent = node.parentElement;
        if (!parent || shouldSkip(parent)) return NodeFilter.FILTER_REJECT;
        return NodeFilter.FILTER_ACCEPT;
      }
    });

    var textNode;
    while ((textNode = walker.nextNode())) {
      cleanTextNode(textNode);
    }
  }

  function run() {
    stripRenderedEmoji(document.querySelector('main') || document.body);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }
})();
</script>

<!-- Auto-hide sidebar TOC when it touches/overlaps content -->
<script>
(function () {
  if (typeof ResizeObserver === 'undefined') return;

  // The outer wrapper that holds the sidebar TOC
  var tocOuter = document.querySelector('.toc-right');
  if (!tocOuter) tocOuter = document.querySelector('.toc');
  var sidebarWrap = tocOuter && tocOuter.closest('div.order-first');
  var contentWrap = document.querySelector('.article-content');
  if (!sidebarWrap || !contentWrap) return;

  var raf = null;

  function check() {
    raf = null;

    // Use window width vs content right to decide overlap,
    // avoiding the toggle-measure-toggle reflow pattern.
    var contentRect = contentWrap.getBoundingClientRect();
    // Sidebar sits after content; if remaining space is too narrow, hide it.
    var spaceRight = window.innerWidth - contentRect.right;
    var overlaps = spaceRight < 280; // sidebar ~256px + 16px gap + tolerance

    if (overlaps) {
      document.body.classList.add('toc-sidebar-hidden');
    } else {
      document.body.classList.remove('toc-sidebar-hidden');
    }
  }

  function scheduleCheck() {
    if (!raf) raf = requestAnimationFrame(check);
  }

  // Watch for size changes on both the content and viewport
  var ro = new ResizeObserver(scheduleCheck);
  ro.observe(contentWrap);
  ro.observe(sidebarWrap);
  ro.observe(document.documentElement);

  // Also recheck on window resize (catches zoom, orientation, etc.)
  window.addEventListener('resize', scheduleCheck, { passive: true });

  check(); // initial run
})();
</script>

<!-- ── Umami: scroll depth + behavior tracking ─────────────────────── -->
<script>
(function(){
  /* Only run on article pages under /posts/ */
  var article = document.querySelector('.article-content');
  if (!article) return;
  if (!/\/posts\/[^/]+/.test(location.pathname)) return;

  /* Slug from URL path (last non-empty segment) */
  var parts = location.pathname.replace(/\/+$/,'').split('/');
  var slug  = parts[parts.length - 1] || 'unknown';

  /* Dev-mode guard: log instead of sending on localhost */
  var isDev = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  function track(name, props) {
    if (isDev) { console.log('[umami-track]', name, props); return; }
    if (typeof umami !== 'undefined' && umami.track) umami.track(name, props);
  }

  /* ── 1. Scroll milestones (50%, 75%, 100%) ── */
  var fired = {};
  var milestones = [0.50, 0.75, 1.00];

  function createSentinel(ratio) {
    var el = document.createElement('div');
    el.style.cssText = 'position:absolute;left:0;width:1px;height:1px;pointer-events:none;';
    el.style.top = (ratio * 100) + '%';
    el.dataset.milestone = Math.round(ratio * 100);
    return el;
  }

  /* article-content needs position:relative for absolute sentinels */
  if (getComputedStyle(article).position === 'static') {
    article.style.position = 'relative';
  }

  var scrollIO = new IntersectionObserver(function(entries) {
    entries.forEach(function(e) {
      if (!e.isIntersecting) return;
      var pct = e.target.dataset.milestone;
      if (fired[pct]) return;
      fired[pct] = true;
      track('scroll-' + pct, { article: slug });
    });
  }, { threshold: 0 });

  milestones.forEach(function(r) {
    var s = createSentinel(r);
    article.appendChild(s);
    scrollIO.observe(s);
  });

  /* ── 2. Code-copy clicks ── */
  document.addEventListener('click', function(e) {
    if (e.target.closest && e.target.closest('.copy-button')) {
      track('code-copy', { article: slug });
    }
  });

  /* ── 3. Collapsible code-diff opens ── */
  document.querySelectorAll('details.code-diff-collapsible').forEach(function(det) {
    det.addEventListener('toggle', function() {
      if (det.open) track('details-open', { article: slug });
    });
  });

  /* ── 4. Section tracking (disabled by default — uncomment to enable) ── */
  /*
  var sectionFired = {};
  var sectionIO = new IntersectionObserver(function(entries) {
    entries.forEach(function(e) {
      if (!e.isIntersecting) return;
      var txt = e.target.textContent.trim().substring(0, 60);
      if (sectionFired[txt]) return;
      sectionFired[txt] = true;
      track('section', { article: slug, name: txt });
    });
  }, { threshold: 0 });
  article.querySelectorAll('h2').forEach(function(h) { sectionIO.observe(h); });
  */
})();
</script>

