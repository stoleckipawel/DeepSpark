{{/* code-diff shortcode: diff view with gutter, syntax highlighting, red/green backgrounds */}}
{{ $title := .Get "title" | default "Diff" }}
{{ $collapsed := eq (.Get "collapsed") "true" }}
{{ $collapsible := eq (.Get "collapsible") "true" }}
{{ $lineCount := len (split .Inner "\n") }}

{{ if or $collapsed $collapsible }}
<details class="code-diff-collapsible"{{ if $collapsible }} open{{ end }}>
  <summary class="code-diff-summary">
    <span class="code-diff-summary__title">{{ $title }}</span>
    <span class="code-diff-summary__meta">{{ $lineCount }} lines â€” click to {{ if $collapsible }}collapse{{ else }}expand{{ end }}</span>
  </summary>
{{ end }}
<div class="code-diff">
  <div class="cd-title">{{ $title }}</div>
  {{ $raw := .Inner }}
  {{ $lines := split $raw "\n" }}
  {{ range $lines }}
    {{ if hasPrefix . "+" }}
      {{ $code := slicestr . 1 }}
      <div class="cd-line cd-add"><span class="cd-gutter">+</span><span class="cd-code">{{ $code }}</span></div>
    {{ else if hasPrefix . "-" }}
      {{ $code := slicestr . 1 }}
      <div class="cd-line cd-remove"><span class="cd-gutter">&minus;</span><span class="cd-code">{{ $code }}</span></div>
    {{ else if hasPrefix . "@" }}
      <div class="cd-line" style="color:var(--ds-code-light);font-weight:600"><span class="cd-gutter"></span><span class="cd-code">{{ . }}</span></div>
    {{ else }}
      <div class="cd-line cd-context"><span class="cd-gutter"></span><span class="cd-code">{{ . }}</span></div>
    {{ end }}
  {{ end }}
</div>
{{ if or $collapsed $collapsible }}
</details>
{{ end }}
